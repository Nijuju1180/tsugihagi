
# 文化祭チケット管理システム

全チケットに一意なQRコードを付与し、販売・引換・集計・管理をリアルタイムで行うWebシステムです。

---

## 主な機能

- **チケット発行・販売・商品引換の管理**
- **QRコードによるチケット管理**（販売・引換時にカメラでQRを読み取り）
- **権限ごとのユーザー管理**（管理者がユーザー作成・削除・パスワード変更可能）
- **リアルタイム集計・グラフ表示**（売上・引換状況を即時反映）
- **ダミーデータ生成機能**（テスト用、Ajax対応）
- **一括販売・一括引換機能**（複数QRをまとめて処理）
- **Ajaxによる即時反映・エラー表示**
- **ログイン・ログアウト機能**
- **チケット状態確認ページ**（QRコードで状態・詳細を即時表示）

---

## チケット状態確認ページ

QRコードをカメラで読み取ると、

- 「販売前」「引換前」「引換済」などの状態を大きく表示
- チケットの詳細情報（ID/クラス/メニュー/フレーバー/金額）をテーブルで表示
- 販売・引換の担当者や日時も別テーブルで表示

---

## チケット販売ページ

- QRコードをカメラで読み取り、未販売のチケットのみ追加可能
- 追加したチケットは一覧で確認でき、合計金額も自動計算
- 「確認画面を表示」→「了解」で一括販売処理（DB更新）
- エラーや重複は画面下部に即時表示

---

## 商品引換ページ

- QRコードをカメラで読み取り、未引換のチケットのみ追加可能
- 追加したチケットは一覧で確認できる
- 「確認画面を表示」→「了解」で一括引換処理（DB更新）

---

## チケット一覧・QR表示ページ

- 全チケットの一覧を表示、クリックでQRコードを拡大表示
- List.jsによるフィルタ・ソート機能
- ダミーチケット生成機能（テスト用）

---

## 集計・グラフページ

- 発行枚数・販売枚数・引換済み枚数・売上高などを集計
- メニューごとの集計・グラフ表示
- 時系列（1時間ごと）の販売・引換状況グラフ

---

## 管理者機能

- 管理者（access_id: `bem130`）のみがユーザー管理ページにアクセス可能
- ユーザーごとに「商品交換権限」「チケット販売権限」「閲覧権限」を付与可能
- ユーザー作成・削除・パスワード変更がAjaxで即時反映

---

## データベース構成

### チケットテーブル (`ticket`)
| カラム名             | 型              | 説明                       |
|---------------------|-----------------|----------------------------|
| ticketid            | int             | チケットID（主キー）       |
| flavor              | text            | チケット種別               |
| hr                  | int             | クラス番号                 |
| menu                | text            | メニュー                   |
| ticketissuetime     | timestamp       | 発行日時                   |
| ticketsalesid       | text, NULL      | 販売担当者ID（NULL可）      |
| ticketsalestime     | timestamp, NULL | 販売日時（NULL可）         |
| productexchangeid   | text, NULL      | 引換担当者ID（NULL可）      |
| productexchangetime | timestamp, NULL | 引換日時（NULL可）         |

### アクセス権限テーブル (`accesspermission`)
| カラム名              | 型      | 説明                       |
|----------------------|---------|----------------------------|
| access_id            | text    | アクセスID（主キー）        |
| password_hash        | varchar | パスワードハッシュ         |
| can_product_exchange | tinyint | 商品引換権限（0/1）        |
| can_ticket_sales     | tinyint | チケット販売権限（0/1）    |
| can_view             | tinyint | 閲覧権限（0/1）            |

---

## QRコードの形式

各チケットに付与するQRコードは

`year,hr,menu,flavor,ticketid`

の形式でコンマ区切りで保存します。

- yearは4桁の整数
- その他はDBと同様
- 例: `2025,61,焼きそば,普通,1`

---

## ファイル構成

- `index.php` : トップページ（README.mdをMarkdownで表示）
- `login.php` : ログイン画面
- `login_check.php` : ログイン認証処理
- `logout.php` : ログアウト処理（セッション破棄）
- `admin.php` : 管理者専用ユーザー管理ページ（作成・削除・パスワード変更すべてAjax）
- `view.php` : チケット情報閲覧・集計・グラフ
- `ticketsales.php` : チケット販売処理（Ajax一括販売対応）
- `productexchange.php` : 商品引換処理（Ajax一括引換対応）
- `ticket_qr_list.php` : チケット一覧・QR表示・ダミーチケット生成（Ajax対応、List.jsフィルタ/ソート）
- `db_access.php` : DBアクセス用関数
- `header.php` : 共通ヘッダー
- `price.php` : チケット価格計算関数
- `style.css` : スタイルシート

---

## 注意事項

- QRコードリーダーはZXingライブラリを利用しています
- ダミーデータ生成はテスト用です。必要に応じてテーブルを空にしてください
- Ajax操作時はエラー内容がアラートや画面下部に即時表示されます