<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</title>
    <!-- handleScriptError é–¢æ•°ã‚’ ZXing ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚ˆã‚Šå‰ã«å®šç¾© -->
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã‚’å®šç¾©
        function handleScriptError(scriptElement) {
            console.error(`[QRCodeReader] ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URL: ${scriptElement.src}`);
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = 'ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                statusElement.className = 'status error';
            }
            // å¿…è¦ã«å¿œã˜ã¦ã€ä»–ã®UIè¦ç´ ã‚‚ç„¡åŠ¹ã«ã™ã‚‹ãªã©ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’è¡Œã†
            const startBtn = document.getElementById('startBtn');
            if (startBtn) startBtn.disabled = true;
        }
    </script>
    <!-- ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã€‚onerrorå±æ€§ã‚’è¿½åŠ ã—ã¦èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’æ•æ‰ -->
    <!-- URLã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸæ–°ã—ã„ã‚‚ã®ã«å¤‰æ›´ -->
    <script src="https://unpkg.com/@zxing/library@latest" onerror="handleScriptError(this)"></script>
    <style>
        /* å…¨ä½“ã®ãƒªã‚»ãƒƒãƒˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ãƒœãƒ‡ã‚£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif; /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
            min-height: 100vh; /* æœ€å°é«˜ã•ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã«è¨­å®š */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* ä¸­å¤®æƒãˆ */
            padding: 20px;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .container {
            background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ã®ç™½èƒŒæ™¯ */
            border-radius: 20px; /* è§’ã‚’ä¸¸ã */
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); /* å½± */
            backdrop-filter: blur(10px); /* èƒŒæ™¯ã®ã¼ã‹ã— */
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px; /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        h1 {
            text-align: center;
            color: #333;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .camera-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* ãƒ“ãƒ‡ã‚ªè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #video {
            width: 100%;
            height: 400px;
            object-fit: cover; /* ç¸¦æ¨ªæ¯”ã‚’ç¶­æŒã—ã¦è¦ç´ ã‚’åŸ‹ã‚ã‚‹ */
            background: #000;
            border-radius: 15px; /* è§’ã‚’ä¸¸ã */
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰Šé™¤ */

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ç¾¤ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* æŠ˜ã‚Šè¿”ã— */
            gap: 15px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            background: linear-gradient(45deg, #667eea, #764ba2); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px; /* ä¸¸ã„ãƒœã‚¿ãƒ³ */
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease; /* ãƒ›ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px); /* å°‘ã—ä¸Šã«ç§»å‹• */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .result {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            min-height: 100px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        /* çµæœè¡¨ç¤ºæˆåŠŸæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .result.success {
            border-color: #4caf50; /* ç·‘è‰²ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
            background: rgba(76, 175, 80, 0.1); /* è–„ã„ç·‘è‰²ã®èƒŒæ™¯ */
            animation: slideIn 0.5s ease; /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* çµæœã‚¿ã‚¤ãƒˆãƒ« */
        .result h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        /* çµæœãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .result-text {
            word-break: break-all; /* é•·ã„å˜èªã‚’æ”¹è¡Œ */
            color: #555;
            font-size: 14px;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šæº–å‚™å®Œäº† */
        .status.ready {
            background: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šã‚¹ã‚­ãƒ£ãƒ³ä¸­ */
        .status.scanning {
            background: rgba(255, 193, 7, 0.2);
            color: #f57c00;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šã‚¨ãƒ©ãƒ¼ */
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #c62828;
        }

        /* ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .copy-btn {
            background: linear-gradient(45deg, #4caf50, #45a049);
            padding: 10px 20px;
            font-size: 14px;
            margin-top: 15px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆä»£æ›¿ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .modal-content button {
            margin-top: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            #video {
                height: 300px;
            }
            .overlay {
                width: 150px;
                height: 150px;
            }
            button {
                padding: 12px 24px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</h1>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
        </div>

        <div class="controls">
            <button id="startBtn">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
            <button id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
            <button id="switchBtn" disabled>ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
        </div>

        <div id="status" class="status">ã‚«ãƒ¡ãƒ©ã®æº–å‚™ãŒã§ãã¾ã—ãŸ</div>

        <div id="result" class="result">
            <h3>ğŸ“‹ èª­ã¿å–ã‚Šçµæœ</h3>
            <div id="resultText" class="result-text">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã®ä»£æ›¿ï¼‰ -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button id="closeModalBtn">OK</button>
        </div>
    </div>

    <script>
        class QRCodeReader {
            constructor() {
                this.codeReader = null; // ZXing BrowserQRCodeReader ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
                this.video = document.getElementById('video'); // ãƒ“ãƒ‡ã‚ªè¦ç´ 
                this.startBtn = document.getElementById('startBtn'); // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³
                this.stopBtn = document.getElementById('stopBtn'); // åœæ­¢ãƒœã‚¿ãƒ³
                this.switchBtn = document.getElementById('switchBtn'); // ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
                this.status = document.getElementById('status'); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºè¦ç´ 
                this.result = document.getElementById('result'); // çµæœè¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠ
                this.resultText = document.getElementById('resultText'); // çµæœãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºè¦ç´ 
                this.isScanning = false; // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã‹ã©ã†ã‹
                this.devices = []; // åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®ãƒªã‚¹ãƒˆ
                this.currentDeviceIndex = 0; // ç¾åœ¨ä½¿ç”¨ä¸­ã®ã‚«ãƒ¡ãƒ©ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                this.stream = null; // ã‚«ãƒ¡ãƒ©ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ  (æœªä½¿ç”¨ã ãŒã€å°†æ¥çš„ãªæ‹¡å¼µã®ãŸã‚ã«æ®‹ã™)

                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®å–å¾—
                this.modal = document.getElementById('myModal');
                this.modalMessage = document.getElementById('modalMessage');
                this.closeModalBtn = document.getElementById('closeModalBtn');

                this.init(); // åˆæœŸåŒ–å‡¦ç†ã‚’é–‹å§‹
            }

            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
            async init() {
                console.log('[QRCodeReader] åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                try {
                    console.log('[QRCodeReader] ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…æ©Ÿä¸­...');
                    // ZXingãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å¾…æ©Ÿ
                    // handleScriptErrorãŒå‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã¯ã€ã“ã®Promiseã¯è§£æ±ºã•ã‚Œãªã„
                    await this.waitForZXing();
                    console.log('[QRCodeReader] ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');

                    console.log('[QRCodeReader] BrowserQRCodeReader ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆã‚’è©¦è¡Œä¸­...');
                    this.codeReader = new ZXing.BrowserQRCodeReader();
                    console.log('[QRCodeReader] BrowserQRCodeReader ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚');

                    console.log('[QRCodeReader] ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®ãƒªã‚¹ãƒˆå–å¾—ã‚’è©¦è¡Œä¸­...');
                    this.devices = await this.codeReader.listVideoInputDevices();
                    console.log('[QRCodeReader] æ¤œå‡ºã•ã‚ŒãŸã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹:', this.devices);

                    if (this.devices.length === 0) {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        console.warn('[QRCodeReader] ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
                        return;
                    }
                    if (this.devices.length > 1) {
                        this.switchBtn.disabled = false;
                        console.log('[QRCodeReader] è¤‡æ•°ã®ã‚«ãƒ¡ãƒ©ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚');
                    }
                    this.setupEventListeners();
                    this.showStatus('ã‚«ãƒ¡ãƒ©ã®æº–å‚™ãŒã§ãã¾ã—ãŸ', 'ready');
                    console.log('[QRCodeReader] åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                } catch (error) {
                    console.error('[QRCodeReader] åˆæœŸåŒ–ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    // Check for specific error types related to camera access
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼è©³ç´°: ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚');
                    } else if (error.name === 'NotFoundError') {
                        this.showStatus('åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼è©³ç´°: åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    } else if (error.name === 'NotReadableError') {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼è©³ç´°: ã‚«ãƒ¡ãƒ©ãŒã™ã§ã«ä½¿ç”¨ä¸­ã§ã™ã€‚');
                    } else if (error.name === 'OverconstrainedError') {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ã®åˆ¶ç´„ã‚’æº€ãŸã›ã¾ã›ã‚“ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼è©³ç´°: ã‚«ãƒ¡ãƒ©ã®åˆ¶ç´„ã‚¨ãƒ©ãƒ¼ã€‚', error.message);
                    } else {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    }
                }
            }

            // ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã¤ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            async waitForZXing() {
                return new Promise((resolve, reject) => {
                    // ZXingãŒæ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    // @zxing/library ã®å ´åˆã€ZXing.BrowserQRCodeReader ã¯ ZXing.BrowserQRCodeReader ã¨ã—ã¦ç›´æ¥åˆ©ç”¨å¯èƒ½
                    if (typeof ZXing !== 'undefined' && typeof ZXing.BrowserQRCodeReader !== 'undefined') {
                        resolve();
                        return;
                    }

                    let scriptLoadFailed = false;
                    const originalHandleScriptError = window.handleScriptError;
                    window.handleScriptError = (scriptElement) => {
                        scriptLoadFailed = true;
                        if (originalHandleScriptError) {
                            originalHandleScriptError(scriptElement); // å…ƒã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã‚‚å‘¼ã³å‡ºã™
                        }
                        reject(new Error('ZXing script failed to load.'));
                    };

                    const checkZXing = () => {
                        if (scriptLoadFailed) {
                            // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€ã‚‚ã†ãƒã‚§ãƒƒã‚¯ã—ãªã„
                            return;
                        }
                        if (typeof ZXing !== 'undefined' && typeof ZXing.BrowserQRCodeReader !== 'undefined') {
                            resolve();
                        } else {
                            setTimeout(checkZXing, 100); // 100msã”ã¨ã«ãƒã‚§ãƒƒã‚¯
                        }
                    };
                    checkZXing();
                });
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners() {
                (async () => { this.startScanning() })();
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.switchBtn.addEventListener('click', () => this.switchCamera());
                this.closeModalBtn.addEventListener('click', () => this.modal.style.display = 'none');
                window.addEventListener('click', (event) => {
                    if (event.target == this.modal) {
                        this.modal.style.display = 'none';
                    }
                });
                console.log('[QRCodeReader] ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚');
            }

            // ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹
            async startScanning() {
                if (this.isScanning) {
                    console.log('[QRCodeReader] ã™ã§ã«ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã§ã™ã€‚');
                    return; // ã™ã§ã«ã‚¹ã‚­ãƒ£ãƒ³ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
                }
                console.log('[QRCodeReader] ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                try {
                    this.isScanning = true;
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.showStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', 'scanning');

                    // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹ã‹å†ç¢ºèª
                    if (this.devices.length === 0) {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼: ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹æ™‚ã«ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                        this.resetButtons();
                        return;
                    }

                    const deviceId = this.devices[this.currentDeviceIndex].deviceId;
                    console.log(`[QRCodeReader] ä½¿ç”¨ã™ã‚‹ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ID: ${deviceId}`);

                    console.log('[QRCodeReader] decodeFromVideoDevice ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™...');
                    this.codeReader.decodeFromVideoDevice(
                        deviceId,
                        this.video,
                        (result, error) => {
                            if (result) {
                                console.log('[QRCodeReader] QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: çµæœã‚ã‚Šã€‚');
                                this.onQRCodeDetected(result);
                            }
                            if (error) {
                                if (error.name !== 'NotFoundException') {
                                    this.showStatus('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                                } else {
                                    console.log('[QRCodeReader] QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: NotFoundException (QRã‚³ãƒ¼ãƒ‰ãªã—)ã€‚');
                                }
                            }
                        }
                    );
                    console.log('[QRCodeReader] decodeFromVideoDevice ãŒæ­£å¸¸ã«å‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸã€‚');

                } catch (error) {
                    console.error('[QRCodeReader] ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    // More specific error handling for startScanning
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼è©³ç´°: ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹æ™‚ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã€‚');
                    } else if (error.name === 'NotReadableError') {
                        this.showStatus('ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™ã€‚ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚', 'error');
                        console.error('[QRCodeReader] ã‚¨ãƒ©ãƒ¼è©³ç´°: ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹æ™‚ã«ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã€‚');
                    } else {
                        this.showStatus('ã‚¹ã‚­ãƒ£ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    }
                    this.resetButtons();
                }
            }

            // ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢
            stopScanning() {
                if (!this.isScanning) {
                    console.log('[QRCodeReader] ã‚¹ã‚­ãƒ£ãƒ³ã¯åœæ­¢ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                    return; // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                }
                console.log('[QRCodeReader] ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã€‚');
                this.isScanning = false;
                this.codeReader.reset(); // ZXingã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåœæ­¢ï¼‰
                console.log('[QRCodeReader] ZXing codeReader ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');

                this.resetButtons(); // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                this.showStatus('ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'ready');
                this.resultText.textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„'; // çµæœè¡¨ç¤ºã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            }

            // ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            async switchCamera() {
                if (this.devices.length <= 1) {
                    console.log('[QRCodeReader] ã‚«ãƒ¡ãƒ©ãŒ1ã¤ã—ã‹ãªã„ãŸã‚ã€åˆ‡ã‚Šæ›¿ãˆã¯ã§ãã¾ã›ã‚“ã€‚');
                    return; // ã‚«ãƒ¡ãƒ©ãŒ1ã¤ä»¥ä¸‹ãªã‚‰åˆ‡ã‚Šæ›¿ãˆä¸å¯
                }
                console.log('[QRCodeReader] ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
                // æ¬¡ã®ã‚«ãƒ¡ãƒ©ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç§»å‹•ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
                const previousDeviceIndex = this.currentDeviceIndex;
                this.currentDeviceIndex = (this.currentDeviceIndex + 1) % this.devices.length;
                console.log(`[QRCodeReader] ã‚«ãƒ¡ãƒ©ã‚’ ${previousDeviceIndex} ã‹ã‚‰ ${this.currentDeviceIndex} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚`);

                // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®å ´åˆã¯ä¸€åº¦åœæ­¢ã—ã¦ã€æ–°ã—ã„ã‚«ãƒ¡ãƒ©ã§å†é–‹
                if (this.isScanning) {
                    console.log('[QRCodeReader] ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã ã£ãŸãŸã‚ã€ä¸€åº¦åœæ­¢ã—ã¦å†é–‹ã—ã¾ã™ã€‚');
                    this.stopScanning();
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†é–‹ (ã‚«ãƒ¡ãƒ©ã®åˆ‡ã‚Šæ›¿ãˆã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚)
                    setTimeout(() => this.startScanning(), 500);
                }
            }

            // QRã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚ŒãŸã¨ãã®å‡¦ç†
            onQRCodeDetected(result) {
                const text = result.getText(); // æ¤œå‡ºã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                console.log('[QRCodeReader] QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸ:', text);

                this.showResult(text); // çµæœã‚’è¡¨ç¤º
                this.showStatus('QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸï¼', 'ready');

                // èª­ã¿å–ã‚ŠæˆåŠŸæ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                this.result.classList.add('success');
                setTimeout(() => {
                    this.result.classList.remove('success');
                }, 2000); // 2ç§’å¾Œã«æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            }

            // çµæœã‚’ç”»é¢ã«è¡¨ç¤º
            showResult(text) {
                this.resultText.innerHTML = `
                    <div style="margin-bottom: 15px;">${this.escapeHtml(text)}</div>
                    <button class="copy-btn">
                        ğŸ“‹ ã‚³ãƒ”ãƒ¼
                    </button>
                `;
                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                const copyBtn = this.resultText.querySelector('.copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(text)
                            .then(() => {
                                this.showAlert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½¿ç”¨
                                console.log('[QRCodeReader] ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
                            })
                            .catch(err => {
                                console.error('[QRCodeReader] ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                                this.showAlert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                            });
                    });
                }
            }

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
            showAlert(message) {
                this.modalMessage.textContent = message;
                this.modal.style.display = 'flex'; // flex ã‚’ä½¿ç”¨ã—ã¦ä¸­å¤®æƒãˆ
                console.log(`[QRCodeReader] ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º: ${message}`);
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¿ã‚¤ãƒ—ã‚’è¡¨ç¤º
            showStatus(message, type) {
                this.status.textContent = message;
                this.status.className = `status ${type}`; // ã‚¯ãƒ©ã‚¹ã‚’å‹•çš„ã«å¤‰æ›´ã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                console.log(`[QRCodeReader] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°: ${message} (${type})`);
            }

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetButtons() {
                this.startBtn.disabled = false; // é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«
                this.stopBtn.disabled = true; // åœæ­¢ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹ã«
                // ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ãŒè¤‡æ•°ã‚ã‚Œã°å¸¸ã«æœ‰åŠ¹ã«ã™ã‚‹
                if (this.devices.length > 1) {
                    this.switchBtn.disabled = false;
                } else {
                    this.switchBtn.disabled = true;
                }
                console.log('[QRCodeReader] ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            }

            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[QRCodeReader] DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚QRCodeReader ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚');
            new QRCodeReader();
        });
    </script>
</body>
</html>
